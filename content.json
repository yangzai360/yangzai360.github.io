{"meta":{"title":"æ‰¬ä»”çš„æŠ€æœ¯åšå®¢","subtitle":"","description":"","author":"yangzai360","url":"http://yangzai360.top","root":"/"},"pages":[],"posts":[{"title":"OC Runtime å¤§æ‰‹ç¨¿ï¼šå››ã€ç±»å¸ƒå±€è¿‡ç¨‹","slug":"OCBigManuscript04_ClassLayout","date":"2020-11-01T03:35:19.688Z","updated":"2020-11-01T03:36:42.691Z","comments":true,"path":"2020/11/01/OCBigManuscript04_ClassLayout/","link":"","permalink":"http://yangzai360.top/2020/11/01/OCBigManuscript04_ClassLayout/","excerpt":"","text":"å¤æ‚åº¦é«˜çš„é¡¹ç›®ç³»ç»Ÿï¼Œæˆ‘æƒ¯äºèŠ±æ—¶é—´æ¢³ç†å‡ºå¤§æ‰‹ç¨¿ï¼Œä½œä¸ºå‚è€ƒï¼Œæ ¹æ®è¿™ä¸ªæ€è·¯ï¼Œæˆ‘èŠ±æ—¶é—´å¯¹äºOCåº•å±‚çš„æœºåˆ¶è¿›è¡Œæ¢³ç†ï¼Œäº§å‡ºå¤§æ‰‹ç¨¿è‹¥å¹²ã€‚ ç¬¬ä¸‰ç¯‡ï¼šç±»å¸ƒå±€è¿‡ç¨‹ åœ¨æ‰§è¡Œåˆ° main ä¹‹å‰ï¼Œ","categories":[],"tags":[]},{"title":"OC Runtime å¤§æ‰‹ç¨¿ï¼šä¸‰ã€å¯¹è±¡é”€æ¯æµç¨‹","slug":"OCBigManuscript03_ObjectDealloc","date":"2020-10-31T13:57:15.140Z","updated":"2020-11-01T01:51:54.562Z","comments":true,"path":"2020/10/31/OCBigManuscript03_ObjectDealloc/","link":"","permalink":"http://yangzai360.top/2020/10/31/OCBigManuscript03_ObjectDealloc/","excerpt":"å¤æ‚åº¦é«˜çš„é¡¹ç›®ç³»ç»Ÿï¼Œæˆ‘æƒ¯äºèŠ±æ—¶é—´æ¢³ç†å‡ºå¤§æ‰‹ç¨¿ï¼Œä½œä¸ºå‚è€ƒï¼Œæ ¹æ®è¿™ä¸ªæ€è·¯ï¼Œæˆ‘èŠ±æ—¶é—´å¯¹äºOCåº•å±‚çš„æœºåˆ¶è¿›è¡Œæ¢³ç†ï¼Œäº§å‡ºå¤§æ‰‹ç¨¿è‹¥å¹²ã€‚ ç¬¬ä¸‰ç¯‡ï¼šå¯¹è±¡é”€æ¯æµç¨‹ æœªå®Œæˆ!NFY Not finished yet. åŸºæœ¬çš„æµç¨‹å·²ç»æ¢³ç†å®Œäº†ï¼Œå›¾æ˜¾å¾—æœ‰äº›çªå…€ï¼Œä¸»è¦æ˜¯å› ä¸ºå³ä¸Šè§’çš„é‚£ä¸ªæ–¹æ³•ä¸­æœ‰å¾ˆå¤šå®˜æ–¹çš„æ³¨é‡Šï¼Œä»¥åŠæˆ‘æ²¡æœ‰å¯¹å…¶è¿›è¡Œæ‹†è§£å’Œç®€åŒ–ã€‚ è¿™é‡Œé¢æœ‰ä¸€äº›çŸ¥è¯†ç‚¹æ²¡æœ‰ç‰¹åˆ«ç»†è‡´çš„å±•å¼€ï¼Œä¾‹å¦‚ï¼š sidetable ç»“æ„å’Œåº”ç”¨æ“ä½œçš„æ•´ç†æ±‡æ€» weak æ•£åˆ—è¡¨çš„æ“ä½œå±•å¼€è®² æœ€åä¸€äº›æµç¨‹ç”¨åˆ°çš„æ–¹æ³•æŸ¥æ‰¾å‡½æ•°æ˜¯ä»…ä»…æä¾›ç»™æŸ¥æ‰¾ æ„é€ å‡½æ•° å’Œ ææ„å‡½æ•° ä½¿ç”¨çš„","text":"å¤æ‚åº¦é«˜çš„é¡¹ç›®ç³»ç»Ÿï¼Œæˆ‘æƒ¯äºèŠ±æ—¶é—´æ¢³ç†å‡ºå¤§æ‰‹ç¨¿ï¼Œä½œä¸ºå‚è€ƒï¼Œæ ¹æ®è¿™ä¸ªæ€è·¯ï¼Œæˆ‘èŠ±æ—¶é—´å¯¹äºOCåº•å±‚çš„æœºåˆ¶è¿›è¡Œæ¢³ç†ï¼Œäº§å‡ºå¤§æ‰‹ç¨¿è‹¥å¹²ã€‚ ç¬¬ä¸‰ç¯‡ï¼šå¯¹è±¡é”€æ¯æµç¨‹ æœªå®Œæˆ!NFY Not finished yet. åŸºæœ¬çš„æµç¨‹å·²ç»æ¢³ç†å®Œäº†ï¼Œå›¾æ˜¾å¾—æœ‰äº›çªå…€ï¼Œä¸»è¦æ˜¯å› ä¸ºå³ä¸Šè§’çš„é‚£ä¸ªæ–¹æ³•ä¸­æœ‰å¾ˆå¤šå®˜æ–¹çš„æ³¨é‡Šï¼Œä»¥åŠæˆ‘æ²¡æœ‰å¯¹å…¶è¿›è¡Œæ‹†è§£å’Œç®€åŒ–ã€‚ è¿™é‡Œé¢æœ‰ä¸€äº›çŸ¥è¯†ç‚¹æ²¡æœ‰ç‰¹åˆ«ç»†è‡´çš„å±•å¼€ï¼Œä¾‹å¦‚ï¼š sidetable ç»“æ„å’Œåº”ç”¨æ“ä½œçš„æ•´ç†æ±‡æ€» weak æ•£åˆ—è¡¨çš„æ“ä½œå±•å¼€è®² æœ€åä¸€äº›æµç¨‹ç”¨åˆ°çš„æ–¹æ³•æŸ¥æ‰¾å‡½æ•°æ˜¯ä»…ä»…æä¾›ç»™æŸ¥æ‰¾ æ„é€ å‡½æ•° å’Œ ææ„å‡½æ•° ä½¿ç”¨çš„ 1References OC çœ‹objcæºç è®¤è¯†retainã€releaseã€deallocã€‚ç¬¬ä¸€ä¸ªæ–­ç‚¹å‡ºç°ä¹‹å‰æœ‰ä¸€å¤§å †retain release å’Œ side table çš„æ“ä½œï¼Œçœ‹ä¸å¤ªæ‡‚ï¼Œçœ‹äº†è¿™ç¯‡æ–‡æ¡£ Objective-C Runtime ä¸­å†…å­˜é‡Šæ”¾çš„å¹¶å‘é—®é¢˜æ„Ÿè°¢è¯‘è€… @ä¸€åªç¾Šçš„åŒ—äº¬ï¼Œæ‰¾è¿™ä¸ª static int _collecting_in_critical(void)ï¼Œæœ‰ç‚¹ç‚¹ä¸ç†è§£çš„åœ°æ–¹ï¼Œè®²çš„å¾ˆé€å½»ï¼Œå…¨ç½‘ä¸­æ–‡èµ„æ–™ç‹¬æ­¤ä¸€ç¯‡ http://zhoulingyu.com/2017/02/15/Advanced-iOS-Study-objc-Memory-2/iOSè¿›é˜¶â€”â€”iOSï¼ˆObjective-Cï¼‰å†…å­˜ç®¡ç†Â·äºŒ","categories":[],"tags":[]},{"title":"å¸¸ç”¨ Runtime æ“ä½œæ•´ç†","slug":"CWC02_CEOOCRuntimeInAction_CookActuallyUsedInCooking","date":"2020-10-31T09:40:39.350Z","updated":"2020-11-01T09:59:06.018Z","comments":true,"path":"2020/10/31/CWC02_CEOOCRuntimeInAction_CookActuallyUsedInCooking/","link":"","permalink":"http://yangzai360.top/2020/10/31/CWC02_CEOOCRuntimeInAction_CookActuallyUsedInCooking/","excerpt":"æœ¬ç¯‡è‹±æ–‡åå« OC Runtime In Actionï¼šCEO Cook Actually Used In Cookingï¼Œç¿»è¯‘è¿‡æ¥çš„æ„æ€æ˜¯å¼€å‘äººå‘˜å®é™…å¼€å‘çš„æ—¶å€™ä½¿ç”¨çš„ runtime æ“ä½œã€‚è¿›è¡Œç§¯ç´¯æ•´ç†ã€‚","text":"æœ¬ç¯‡è‹±æ–‡åå« OC Runtime In Actionï¼šCEO Cook Actually Used In Cookingï¼Œç¿»è¯‘è¿‡æ¥çš„æ„æ€æ˜¯å¼€å‘äººå‘˜å®é™…å¼€å‘çš„æ—¶å€™ä½¿ç”¨çš„ runtime æ“ä½œã€‚è¿›è¡Œç§¯ç´¯æ•´ç†ã€‚ éš¶å±äºæˆ‘çš„ç¬¬äºŒä¸ªå¤§ç³»åˆ— CWC ï¼šCooking With Cookï¼Œç¿»è¯‘è¿‡æ¥çš„ä¸­æ–‡æ„æ€å°±æ˜¯ ä½œä¸ºä¸€ä¸ªé•¿æœŸçƒ­çˆ±è‹¹æœçš„è‹¹æœå¼€å‘è€…ï¼Œé™ªç€æ°´æœå…¬å¸ä¸€èµ·ç§¯ç´¯å’Œæˆé•¿ã€‚ 1. æ¥è§¦ Runtime çš„æ–¹å¼æ­£å¸¸å¼€å‘çš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‰ä¸ªæ¸ é“æ¥æ¥è§¦åˆ°runtime OC å±‚é¢, egï¼š @selector Runtime APIï¼Œ eg: objc-getclass() è¿™äº›æ–¹æ³•ï¼ŒmsgSend()ï¼ŒsetassosiciatedObject()ç­‰ NSObject ç›¸å…³çš„ API, eg: 2. åœ¨lldbä¸­æ‰“å° objc_class isa çš„æŒ‡å‘ç±»è¿™ç‚¹è™½ç„¶ä¸æ˜¯è°ƒç”¨runtimeï¼Œä½†æ˜¯æ¶‰åŠåˆ°äº†isaæŒ‡é’ˆçš„ç›¸å…³çŸ¥è¯†ã€‚ ç›´æ¥é€šè¿‡ä½è¿ç®—ä¸ä¸Šæ©ç æ¥å–ç±»æŒ‡é’ˆ è¿™é‡Œä¸æ“ä½œåé¢çš„å€¼å°±æ˜¯ ISAMASKï¼Œæ ¹æ®æ“ä½œå¹³å°ä¸åŒã€‚ 3. é€šè¿‡ @encode æ‰“å°æ‰€æœ‰çš„type encodingshttps://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html#//apple_ref/doc/uid/TP40008048-CH100 è¿™ä¸ªè¿˜æ˜¯æœ‰ç”¨çš„ï¼Œå› ä¸ºå…¶å® method_t é‡Œé¢æ»¡å…±å°±ä¸‰å››ä¸ªå€¼ï¼Œä¸€ä¸ªnameï¼Œä¸€ä¸ªimpå®ç°æŒ‡é’ˆï¼Œä¸€ä¸ªå°±æ˜¯æ–¹æ³•çš„ TypeEncodings 12345678910111213141516171819202122232425262728293031323334353637#pragma mark - å„ç§ç±»å‹ç¼–ç void logAllTypeCodings() &#123; NSLog(@&quot;char --&gt; %s&quot;,@encode(char)); NSLog(@&quot;int --&gt; %s&quot;,@encode(int)); NSLog(@&quot;short --&gt; %s&quot;,@encode(short)); NSLog(@&quot;long --&gt; %s&quot;,@encode(long)); NSLog(@&quot;long long --&gt; %s&quot;,@encode(long long)); NSLog(@&quot;unsigned char --&gt; %s&quot;,@encode(unsigned char)); NSLog(@&quot;unsigned int --&gt; %s&quot;,@encode(unsigned int)); NSLog(@&quot;unsigned short --&gt; %s&quot;,@encode(unsigned short)); NSLog(@&quot;unsigned long --&gt; %s&quot;,@encode(unsigned long long)); NSLog(@&quot;float --&gt; %s&quot;,@encode(float)); NSLog(@&quot;bool --&gt; %s&quot;,@encode(bool)); NSLog(@&quot;void --&gt; %s&quot;,@encode(void)); NSLog(@&quot;char * --&gt; %s&quot;,@encode(char *)); NSLog(@&quot;id --&gt; %s&quot;,@encode(id)); NSLog(@&quot;Class --&gt; %s&quot;,@encode(Class)); NSLog(@&quot;SEL --&gt; %s&quot;,@encode(SEL)); int array[] = &#123;1,2,3&#125;; NSLog(@&quot;int[] --&gt; %s&quot;,@encode(typeof(array))); typedef struct person&#123; char *name; int age; &#125;Person; NSLog(@&quot;struct --&gt; %s&quot;,@encode(Person)); typedef union union_type&#123; char *name; int a; &#125;Union; NSLog(@&quot;union --&gt; %s&quot;,@encode(Union)); int a = 2; int *b = &#123;&amp;a&#125;; NSLog(@&quot;int[] --&gt; %s&quot;,@encode(typeof(b)));&#125; 12345678910111213141516171819202020-11-01 15:21:03.434385+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] char --&gt; c2020-11-01 15:21:03.434742+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] int --&gt; i2020-11-01 15:21:03.434775+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] short --&gt; s2020-11-01 15:21:03.434796+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] long --&gt; q2020-11-01 15:21:03.434815+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] long long --&gt; q2020-11-01 15:21:03.434834+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] unsigned char --&gt; C2020-11-01 15:21:03.434855+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] unsigned int --&gt; I2020-11-01 15:21:03.434873+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] unsigned short --&gt; S2020-11-01 15:21:03.434891+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] unsigned long --&gt; Q2020-11-01 15:21:03.434910+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] float --&gt; f2020-11-01 15:21:03.434957+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] bool --&gt; B2020-11-01 15:21:03.434998+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] void --&gt; v2020-11-01 15:21:03.435051+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] char * --&gt; *2020-11-01 15:21:03.733132+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] id --&gt; @2020-11-01 15:21:03.733181+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] Class --&gt; #2020-11-01 15:21:03.733214+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] SEL --&gt; :2020-11-01 15:21:03.733242+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] int[] --&gt; [3i]2020-11-01 15:21:03.733270+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] struct --&gt; &#123;person=*i&#125;2020-11-01 15:21:03.733297+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] union --&gt; (union_type=*i)2020-11-01 15:21:03.733324+0800 001-ç±»çš„å±æ€§ä¸å˜é‡[34325:1798027] int[] --&gt; ^i 4. æ‰“å°æ‰€æœ‰çš„ç±»çš„å±æ€§12345678910111213141516171819202122232425262728293031#import &lt;objc/runtime.h&gt;#ifdef DEBUG#define LGLog(format, ...) printf(&quot;%s\\n&quot;, [[NSString stringWithFormat:format, ## __VA_ARGS__] UTF8String]);#else#define LGLog(format, ...);#endifvoid getObjc_copyIvar_copyProperies(Class pClass)&#123; unsigned int count = 0; Ivar *ivars = class_copyIvarList(pClass, &amp;count); for (unsigned int i=0; i &lt; count; i++) &#123; Ivar const ivar = ivars[i]; //è·å–å®ä¾‹å˜é‡å const char*cName = ivar_getName(ivar); NSString *ivarName = [NSString stringWithUTF8String:cName]; LGLog(@&quot;class_copyIvarList:%@&quot;,ivarName); &#125; free(ivars); unsigned int pCount = 0; objc_property_t *properties = class_copyPropertyList(pClass, &amp;pCount); for (unsigned int i=0; i &lt; pCount; i++) &#123; objc_property_t const property = properties[i]; //è·å–å±æ€§å NSString *propertyName = [NSString stringWithUTF8String:property_getName(property)]; //è·å–å±æ€§å€¼ LGLog(@&quot;class_copyProperiesList:%@&quot;,propertyName); &#125; free(properties);&#125; #5. æŸ¥æ‰¾ æ–¹æ³• ä¸åƒä¸Šä¸€ç‚¹é‚£ä¹ˆé€šç”¨ï¼Œéœ€è¦æ‰‹åŠ¨æŸ¥æ˜¯å¦åŒ…å«è¯¥æ–¹æ³• 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768#import &lt;objc/runtime.h&gt;#ifdef DEBUG#define getLog(format, ...) printf(&quot;%s\\n&quot;, [[NSString stringWithFormat:format, ## __VA_ARGS__] UTF8String]);#else#define getLog(format, ...);#endifvoid getObjc_copyMethodList(Class pClass) &#123; unsigned int count = 0; Method *methods = class_copyMethodList(pClass, &amp;count); for (unsigned int i=0; i &lt; count; i++) &#123; Method const method = methods[i]; //è·å–æ–¹æ³•å NSString *key = NSStringFromSelector(method_getName(method)); getLog(@&quot;Method, name: %@&quot;, key); &#125; free(methods);&#125;void getInstanceMethod_classToMetaclass(Class pClass) &#123; const char *className = class_getName(pClass); Class metaClass = objc_getMetaClass(className); Method method1 = class_getInstanceMethod(pClass, @selector(sayHello)); Method method2 = class_getInstanceMethod(metaClass, @selector(sayHello)); Method method3 = class_getInstanceMethod(pClass, @selector(sayHappy)); Method method4 = class_getInstanceMethod(metaClass, @selector(sayHappy)); getLog(@&quot;%s - %p-%p-%p-%p&quot;,__func__,method1,method2,method3,method4);&#125;void getClassMethod_classToMetaclass(Class pClass) &#123; const char *className = class_getName(pClass); Class metaClass = objc_getMetaClass(className); Method method1 = class_getClassMethod(pClass, @selector(sayHello)); Method method2 = class_getClassMethod(metaClass, @selector(sayHello)); Method method3 = class_getClassMethod(pClass, @selector(sayHappy)); // å…ƒç±» ä¸ºä»€ä¹ˆæœ‰ sayHappy ç±»æ–¹æ³• 0 1 // Method method4 = class_getClassMethod(metaClass, @selector(sayHappy)); getLog(@&quot;%s-%p-%p-%p-%p&quot;,__func__,method1,method2,method3,method4);&#125;void getIMP_classToMetaclass(Class pClass) &#123; const char *className = class_getName(pClass); Class metaClass = objc_getMetaClass(className); // - (void)sayHello; // + (void)sayHappy; IMP imp1 = class_getMethodImplementation(pClass, @selector(sayHello)); IMP imp2 = class_getMethodImplementation(metaClass, @selector(sayHello)); IMP imp3 = class_getMethodImplementation(pClass, @selector(sayHappy)); IMP imp4 = class_getMethodImplementation(metaClass, @selector(sayHappy)); NSLog(@&quot;%p-%p-%p-%p&quot;,imp1,imp2,imp3,imp4); NSLog(@&quot;%s&quot;,__func__);&#125; 6. print all properties12345678910111213141516//- (void)printClassAllProperties:(Class)cls &#123;void printClassAllProperties(Class cls) &#123; unsigned int outCount = 0; objc_property_t *properties = class_copyPropertyList(cls, &amp;outCount); NSMutableArray *propertiesAry = [NSMutableArray arrayWithCapacity:outCount]; for (int i = 0; i&lt;outCount; i++) &#123; // objc property t å±æ€§ objc_property_t property = properties[i]; // è·å–å±æ€§åç§° Cå­—ç¬¦ä¸² const char *cName = property_getName(property); // è½¬æ¢æˆ OC å­—ç¬¦ä¸² NSString *name = [NSString stringWithCString:cName encoding:NSUTF8StringEncoding]; [propertiesAry addObject:name]; NSLog(@&quot;å±æ€§ï¼š %@&quot;, name); &#125;&#125; å¦å¤–è¿™é‡Œæœ‰ä¸€ä¸ªå¦å¤–çš„å‡½æ•°ï¼Œè¯»å–property çš„ attributeï¼Œproperty_getAttributes(property) æ‰“å°å‡ºæ¥ä¼šæ¯”å¦‚è¿™ç§ï¼šT@&quot;NSString&quot;,C,N,V_name","categories":[],"tags":[]},{"title":"ä» LLVM åˆ° clang","slug":"From_LLVM_to_clang","date":"2020-10-31T06:32:48.421Z","updated":"2020-10-31T19:04:19.112Z","comments":true,"path":"2020/10/31/From_LLVM_to_clang/","link":"","permalink":"http://yangzai360.top/2020/10/31/From_LLVM_to_clang/","excerpt":"NFY NotFinishedYetï¼šè¿˜æ²¡æœ‰å†™å®Œã€‚ã€‚ã€‚","text":"NFY NotFinishedYetï¼šè¿˜æ²¡æœ‰å†™å®Œã€‚ã€‚ã€‚ æœ¬ç¯‡è‹±æ–‡åå« From LLVM To Clang: Cook Spend Money Buy A Big Kitchenï¼Œç¿»è¯‘è¿‡æ¥çš„æ„æ€æ˜¯ä» LLVM ç ”ç©¶åˆ° Clang çš„ä¸€ä¸ªç®€å•äº†è§£å’Œä»‹ç»ï¼Œè‹¹æœåœ¨è¿™ä¸ªä¸Šé¢èŠ±äº†å¾ˆå¤šç²¾åŠ›å’Œæ—¶é—´çš„æŠ•å…¥ï¼Œæ‰€ä»¥å€¼å¾—æˆ‘ä»¬å¥½å¥½ç ”ç©¶ã€‚ éš¶å±äºæˆ‘çš„ç¬¬äºŒä¸ªå¤§ç³»åˆ—ï¼šCookingWithCookï¼Œç¿»è¯‘è¿‡æ¥çš„ä¸­æ–‡æ„æ€å°±æ˜¯ ä½œä¸ºä¸€ä¸ªé•¿æœŸçƒ­çˆ±è‹¹æœçš„è‹¹æœå¼€å‘è€…ï¼Œè·Ÿéšè‹¹æœå…¬å¸ä¸€èµ·ç§¯ç´¯å’Œæˆé•¿ã€‚ ä» LLVM åˆ° clang 1.1 ç®€ä»‹ï¼šå¼€å‘æ•…äº‹è‹±æ–‡å…¨ç§°ï¼šLow Level Virtual Machine LLVM è®¡åˆ’å¯åŠ¨äº2000å¹´ï¼Œæœ€åˆç”±ç¾å›½UIUCå¤§å­¦çš„ Chris Lattner åšå£«ä¸»æŒå¼€å±•ã€‚ 2006å¹´Chris LattneråŠ ç›ŸApple Inc. å¹¶è‡´åŠ›äº LLVM åœ¨ Apple å¼€å‘ä½“ç³»ä¸­çš„åº”ç”¨ã€‚Apple ä¹Ÿæ˜¯ LLVM è®¡åˆ’çš„ä¸»è¦èµ„åŠ©è€…ã€‚ ç›®å‰ LLVM å·²ç»è¢«Appleã€Microsoftã€Googleã€Facebookç­‰å„å¤§å…¬å¸é‡‡ç”¨ã€‚ Appleå·²ç»å°†å®ƒç”¨åœ¨OpenCLçš„æµæ°´çº¿ä¼˜åŒ–ï¼ŒXcodeå·²ç»èƒ½ä½¿ç”¨llvm-gccç¼–è¯‘ä»£ç ã€‚ 2011-12-02 LLVM3.0å‘å¸ƒï¼ŒLLVMåŒ…æ‹¬äº†ä¸€ç³»åˆ—å­é¡¹ç›®ï¼Œå®ƒä»¬ä¹ŸåŒæ­¥å‘å¸ƒäº†æ–°ç‰ˆæœ¬ï¼Œå¦‚C/C++/Objective-Cå‰ç«¯Clang 3.0æ”¹è¿›äº†C++ç¨‹åºç¼–è¯‘æ”¯æŒï¼›æ”¹è¿›C++ 2011æ ‡å‡†æ”¯æŒï¼›å®ç°æ”¯æŒå³å°†å‘å¸ƒçš„C1xæ ‡å‡†çš„æŸäº›ç‰¹æ€§ï¼›æ›´å¿«çš„ç”Ÿæˆä»£ç ï¼Œæ›´å¿«çš„ç¼–è¯‘ï¼Œç­‰ç­‰ã€‚ å¯¹äºæ™®é€šçš„å¼€å‘äººå‘˜æ¥è¯´ï¼ŒLLVMè®¡åˆ’æä¾›äº†è¶Šæ¥è¶Šå¤šçš„å¯ä»¥ä½¿ç”¨ã€ç¼–è¯‘å™¨ä»¥å¤–çš„å…¶ä»–å·¥å…·ã€‚ä¾‹å¦‚ä»£ç é™æ€æ£€æŸ¥å·¥å…·LLVM/Clang Static Analyzerï¼Œæ˜¯ä¸€ä¸ª Clang çš„å­é¡¹ç›®ï¼Œèƒ½å¤Ÿä½¿ç”¨åŒæ ·çš„ Makefile ç”Ÿæˆ HTML æ ¼å¼çš„åˆ†ææŠ¥å‘Šã€‚ 1.2 åŠŸèƒ½ç®€ä»‹LLVM æ ¸å¿ƒåº“æä¾›äº†ä¸ç¼–è¯‘å™¨ç›¸å…³çš„æ”¯æŒï¼Œå¯ä»¥ä½œä¸ºå¤šç§è¯­è¨€ç¼–è¯‘å™¨çš„åå°æ¥ä½¿ç”¨ã€‚èƒ½å¤Ÿè¿›è¡Œç¨‹åºè¯­è¨€çš„ç¼–è¯‘æœŸä¼˜åŒ–ã€é“¾æ¥ä¼˜åŒ–ã€åœ¨çº¿ç¼–è¯‘ä¼˜åŒ–ã€ä»£ç ç”Ÿæˆã€‚ LLVMæ˜¯ä¼Šåˆ©è¯ºä¼Šå¤§å­¦çš„ä¸€ä¸ªç ”ç©¶é¡¹ç›®ï¼Œæä¾›ä¸€ä¸ªç°ä»£åŒ–çš„ï¼ŒåŸºäºSSAçš„ç¼–è¯‘ç­–ç•¥èƒ½å¤ŸåŒæ—¶æ”¯æŒé™æ€å’ŒåŠ¨æ€çš„ä»»æ„ç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘ç›®æ ‡ã€‚ LLVM ç”¨ C++ ç¼–å†™ï¼Œç”¨äºä¼˜åŒ–ä»»æ„ç¼–ç¨‹è¯­è¨€ç¼–å†™çš„ç¨‹åºçš„ç¼–è¯‘è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ï¼š ç¼–è¯‘æ—¶é—´ é“¾æ¥æ—¶é—´ è¿è¡Œæ—¶é—´ ç©ºé—²æ—¶é—´ LLVMçš„é¡¹ç›®æ˜¯ä¸€ä¸ªæ¨¡å—åŒ–å’Œå¯é‡å¤ä½¿ç”¨çš„ç¼–è¯‘å™¨å’Œå·¥å…·æŠ€æœ¯çš„é›†åˆ æˆ‘ä»¬å¸¸æ¥è§¦çš„LLVMï¼Œæ¯”å¦‚ç»å¸¸ä½¿ç”¨å¦‚ä¸‹çš„å‘½ä»¤å»ç¼–è¯‘ main.c 123456789clang -rewrite-objc main.m -o main.cppclang -rewrite-objc -fobjc-arc -fobjc&#x3D;runtime&#x3D;ios-13.0.0 -istroot &#x2F;Applications&#x2F;Xcode.app&#x2F;Contents&#x2F;Developer&#x2F;Plantforms&#x2F;iPhoneSimulator.plantform&#x2F;Developer&#x2F;SDKs&#x2F;iPhoneSimulator13.0.sdk main.m main.m -o main.cpp&#x2F;&#x2F;xcode å®‰è£…è‡ªå¸¦ä¸€ä¸ª xcrun å‘½ä»¤ï¼Œå…¶å®xcrun æ˜¯ç»§å®‡ clang è¿›è¡Œçš„å°è£…ï¼Œæ›´å¥½ç”¨ä¸€äº›xcrun -SDK iphonesimulator clang -arch arm64 -rewrite-objc main.m -o main-arm64.cpp (æ¨¡æ‹Ÿå™¨)xcrun -SDK iphoneos clang -arch arm64 -rewrite-objc main.m -o main-arm64.cpp (æ‰‹æœº) Referencesllvm.org LLVM å…¥é—¨ç¯‡ä½œè€…è¯´å›½å†…æœ‰å…³LLVMçš„ä¸œè¥¿å¤ªç¼ºä¹äº† è‹¹æœå®˜æ–¹ç®€ä»‹æ–‡æ¡£ WWDC Session å…³äº LLVM çš„éƒ¨åˆ† https://www.oschina.net/p/llvm ç³»åˆ—ä¼šhttp://llvm-hpc2-workshop.github.io https://llvm.comptechs.cn/docs/å¦‚æœæ‚¨æ˜¯ä»…å¯¹ä½¿ç”¨åŸºäºLLVMçš„ç¼–è¯‘å™¨æ„Ÿå…´è¶£çš„ç”¨æˆ·ï¼Œåˆ™åº”è¯¥æŸ¥çœ‹Clangæ–‡æ¡£ï¼šhttps://clang.llvm.org çŸ­åšå®¢åšå®¢ï¼šLLVMç¼–è¯‘åŸç†å’Œä½¿ç”¨ åšå®¢ï¼šæ·±å…¥æµ…å‡ºè®©ä½ ç†è§£ä»€ä¹ˆæ˜¯LLVM https://my.oschina.net/u/4360182/blog/3279626","categories":[],"tags":[]},{"title":"OC Runtime å¤§æ‰‹ç¨¿ï¼šäºŒã€å®ä¾‹åŒ–æºç æµç¨‹","slug":"OCBigManuscript02_ObjectAllocInit","date":"2020-10-29T18:36:59.398Z","updated":"2020-11-01T00:38:41.449Z","comments":true,"path":"2020/10/30/OCBigManuscript02_ObjectAllocInit/","link":"","permalink":"http://yangzai360.top/2020/10/30/OCBigManuscript02_ObjectAllocInit/","excerpt":"å¤æ‚åº¦é«˜çš„é¡¹ç›®ç³»ç»Ÿï¼Œæˆ‘æƒ¯äºèŠ±æ—¶é—´æ¢³ç†å‡ºå¤§æ‰‹ç¨¿ï¼Œä½œä¸ºå‚è€ƒï¼Œæ ¹æ®è¿™ä¸ªæ€è·¯ï¼Œæˆ‘èŠ±æ—¶é—´å¯¹äºOCåº•å±‚çš„æœºåˆ¶è¿›è¡Œæ¢³ç†ï¼Œäº§å‡ºå¤§æ‰‹ç¨¿è‹¥å¹²ã€‚ ç¬¬äºŒç¯‡ï¼šå®ä¾‹åŒ–æºç æµç¨‹","text":"å¤æ‚åº¦é«˜çš„é¡¹ç›®ç³»ç»Ÿï¼Œæˆ‘æƒ¯äºèŠ±æ—¶é—´æ¢³ç†å‡ºå¤§æ‰‹ç¨¿ï¼Œä½œä¸ºå‚è€ƒï¼Œæ ¹æ®è¿™ä¸ªæ€è·¯ï¼Œæˆ‘èŠ±æ—¶é—´å¯¹äºOCåº•å±‚çš„æœºåˆ¶è¿›è¡Œæ¢³ç†ï¼Œäº§å‡ºå¤§æ‰‹ç¨¿è‹¥å¹²ã€‚ ç¬¬äºŒç¯‡ï¼šå®ä¾‹åŒ–æºç æµç¨‹ ä¸Šå›¾ è¿™ç¯‡ç”»å›¾åºŸäº†10å¤šä¸ªå°æ—¶æ—¶é—´ï¼Œå…ˆä¸å±•å¼€å†™äº†ï¼Œåé¢æœ‰ç©ºå†è¡¥ä¸Šå§ Referenceshttps://www.jianshu.com/p/9d649ce6d0b8 https://blog.csdn.net/myiphon/article/details/105159233 https://github.com/draveness/analyze/blob/master/contents/objc/æ·±å…¥è§£æ%20ObjC%20ä¸­æ–¹æ³•çš„ç»“æ„.md#æ·±å…¥è§£æ-objc-ä¸­æ–¹æ³•çš„ç»“æ„ https://www.jianshu.com/p/9d649ce6d0b8 å¤§æ„Ÿè°¢ï¼šéœœç¥çš„è¿™ç¯‡Objc å¯¹è±¡çš„ä»Šç”Ÿä»Šä¸– https://www.jianshu.com/p/f725d2828a2f","categories":[],"tags":[]},{"title":"Apple æºç ç”¨åˆ°çš„ä¸€äº›æ•°æ®ç»“æ„","slug":"CWC01_KitchenToolsThatCookLoves","date":"2020-10-28T10:00:23.399Z","updated":"2020-10-31T15:46:24.335Z","comments":true,"path":"2020/10/28/CWC01_KitchenToolsThatCookLoves/","link":"","permalink":"http://yangzai360.top/2020/10/28/CWC01_KitchenToolsThatCookLoves/","excerpt":"æœ¬ç¯‡è‹±æ–‡åå« Kitchen Tools That Cook Lovesï¼Œç¿»è¯‘è¿‡æ¥çš„æ„æ€æ˜¯è‹¹æœæºç ä¸­å‡ºç°çš„ä¸€äº›æ•°æ®ç»“æ„ï¼Œä¸æ–­ç§¯ç´¯æ›´æ–°ã€‚ éš¶å±äºæˆ‘çš„ç¬¬äºŒä¸ªå¤§ç³»åˆ— CWC ï¼šCooking With Cookï¼Œç¿»è¯‘è¿‡æ¥çš„ä¸­æ–‡æ„æ€å°±æ˜¯ ä½œä¸ºä¸€ä¸ªé•¿æœŸçƒ­çˆ±è‹¹æœçš„è‹¹æœå¼€å‘è€…ï¼Œé™ªç€æ°´æœå…¬å¸ä¸€èµ·ç§¯ç´¯å’Œæˆé•¿ã€‚ ç›®å‰ï¼šentsize_list_ttã€list_array_ttâ€¦","text":"æœ¬ç¯‡è‹±æ–‡åå« Kitchen Tools That Cook Lovesï¼Œç¿»è¯‘è¿‡æ¥çš„æ„æ€æ˜¯è‹¹æœæºç ä¸­å‡ºç°çš„ä¸€äº›æ•°æ®ç»“æ„ï¼Œä¸æ–­ç§¯ç´¯æ›´æ–°ã€‚ éš¶å±äºæˆ‘çš„ç¬¬äºŒä¸ªå¤§ç³»åˆ— CWC ï¼šCooking With Cookï¼Œç¿»è¯‘è¿‡æ¥çš„ä¸­æ–‡æ„æ€å°±æ˜¯ ä½œä¸ºä¸€ä¸ªé•¿æœŸçƒ­çˆ±è‹¹æœçš„è‹¹æœå¼€å‘è€…ï¼Œé™ªç€æ°´æœå…¬å¸ä¸€èµ·ç§¯ç´¯å’Œæˆé•¿ã€‚ ç›®å‰ï¼šentsize_list_ttã€list_array_ttâ€¦ entsize_list_ttentsize_list_tt å…¶å®å°±æ˜¯ä¸€ä¸ªé€šç”¨çš„å®¹å™¨ï¼Œå¯ä»¥è·å– å†…éƒ¨çš„è¿­ä»£å™¨ï¼Œç”¨äºéå†å†…éƒ¨å­˜å‚¨çš„å…ƒç´  Element: å…ƒç´ çš„ç±»å‹ List: æŒ‡å®šå®¹å™¨çš„å…·ä½“å®ç°ç±»å‹ uint32_t flagmask: flagmask æ ‡è®°ä½ å‡ºç°åœºæ™¯ï¼š ç±»çš„ ro ä¸­çš„ ivar_list_t ç±»çš„ ro rw rwe ä¸­çš„ property_array_t ä¸­çš„ property_list_t ç±»çš„ ro rw rwe ä¸­çš„ method_array_t ä¸­çš„ method_list_t ä¸‰è€…çš„å£°æ˜å¤´å¦‚ä¸‹ï¼š 123struct ivar_list_t : entsize_list_tt&lt;ivar_t, ivar_list_t, 0&gt;struct property_list_t : entsize_list_tt&lt;property_t, property_list_t, 0&gt;struct method_list_t : entsize_list_tt&lt;method_t, method_list_t, 0x3&gt; entsize_list_t å®šä¹‰æºç ï¼Œçœç•¥å¤§éƒ¨åˆ†æ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728/************************************************************************ entsize_list_tt&lt;Element, List, FlagMask&gt;* ä¸€ç³»åˆ—éç²¾è‡´ç»“æ„ä½“çš„æ•°ç»„çš„å®ç°** Element å…ƒç´ æ˜¯ç»“æ„ä½“ç±»å‹ (e.g. method_t)* List æ˜¯è¿™ä¸ªç»“æ„ä½“çš„ç‰¹æ®Šå®ç°å­ç±» (e.g. method_list_t)* FFlagMask ç”¨äºåœ¨ entsize å­—æ®µä¸­å­˜å‚¨é¢å¤–çš„ä½* (e.g. method list fixup markers)**********************************************************************/template &lt;typename Element, typename List, uint32_t FlagMask&gt;struct entsize_list_tt &#123; uint32_t entsizeAndFlags; uint32_t count; Element first; struct iterator; struct iterator &#123; uint32_t entsize; uint32_t index; // keeping track of this saves a divide in operator- Element* element; typedef std::random_access_iterator_tag iterator_category; typedef Element value_type; typedef ptrdiff_t difference_type; typedef Element* pointer; typedef Element&amp; reference; &#125;&#125; list_array_ttè¿™ä¸ªç±»ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªç©ºã€å•æ•°ç»„ã€æˆ–è€…å¤šæ•°ç»„ã€‚å®ƒå’Œ list çš„åŒºåˆ«å°±æ˜¯ å¤šäº†ä¸€ä¸ªå¤šç»´æ•°ç»„çš„å°è£…ã€‚ å‡ºç°åœºæ™¯ï¼š ç±»çš„ rw rwe ä¸­çš„ method_array_t ç±»çš„ rw rwe ä¸­çš„ property_array_t ç±»çš„ rw rwe ä¸­çš„ protocol_array_t ro ä¸­æ²¡æœ‰ï¼Œåªæœ‰ä¸‰ä¸ªå• Listã€‚ ä¸‰è€…çš„å£°æ˜å¤´å¦‚ä¸‹ï¼š 12345678class method_array_t : public list_array_tt&lt;method_t, method_list_t&gt; class property_array_t : public list_array_tt&lt;property_t, property_list_t&gt; class protocol_array_t : public list_array_tt&lt;protocol_ref_t, protocol_list_t&gt; list_array_tt æºç éƒ¨åˆ†å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829/************************************************************************ list_array_tt&lt;Element, List&gt;* å…ƒæ•°æ®çš„é€šç”¨å®ç°ï¼Œå¯ä»¥æŒ‰ç±»åˆ«è¿›è¡Œæ‰©å±•ã€‚** Elementï¼šåŸºç¡€å…ƒæ•°æ®ç±»å‹(e.g. method_t)* Listï¼š å…ƒæ•°æ®çš„åˆ—è¡¨ç±»å‹(e.g. method_list_t)** list_array_ttå…·æœ‰ä»¥ä¸‹ä¸‰ä¸ªå€¼ä¹‹ä¸€ï¼š* - ç©º* - æŒ‡å‘å•ä¸ªåˆ—è¡¨çš„æŒ‡é’ˆ* - æŒ‡å‘å¤šä¸ªåˆ—è¡¨çš„æŒ‡é’ˆçš„æ•°ç»„** countLists/beginLists/endLists è¿­ä»£å…ƒæ•°æ®* count/begin/end è¿­ä»£åŸºç¡€å…ƒæ•°æ®å…ƒç´ **********************************************************************/template &lt;typename Element, typename List&gt;class list_array_tt &#123; struct array_t &#123; uint32_t count; List* lists[0]; static size_t byteSize(uint32_t count) &#123; return sizeof(array_t) + count*sizeof(lists[0]); &#125; size_t byteSize() &#123; return byteSize(count); &#125; &#125;;&#125; æ‰©å±•æ‰©å±•ï¼šnon-fragile structs æ˜¯ä»€ä¹ˆï¼ŸOC 1.0 ï¼ˆiOSè‡ªå§‹è‡³ç»ˆéƒ½æ˜¯2.0èµ·çš„ï¼ŒMacæœ€å¼€å§‹æ˜¯1.0ï¼‰è¯‘å™¨ç”Ÿæˆäº†ä¸€ä¸ª ivar å¸ƒå±€ï¼Œæ˜¾ç¤ºäº†åœ¨ç±»ä¸­ä»å“ªå¯ä»¥è®¿é—®ivarsï¼Œå¯¹ ivar çš„è®¿é—®å°±å¯ä»¥é€šè¿‡ å¯¹è±¡åœ°å€ ï¼‹ ivaråç§»å­—èŠ‚ çš„æ–¹æ³•ã€‚è‹¹æœæ›´æ–°äº†NSObjectç±»ï¼Œä¾‹å¦‚å¢åŠ ä¸€äº›å±æ€§ï¼Œè¿™ä¸ªåˆæ˜¯é™æ€åº“ï¼Œå‘å¸ƒæ–°ç‰ˆæœ¬çš„ç³»ç»Ÿï¼Œè¿™ä¸ªæ—¶å€™å¸ƒå±€å°±å‡ºé”™äº†ï¼Œå°±ä¸å¾—ä¸é‡æ–°ç¼–è¯‘å­ç±»æ¥æ¢å¤å…¼å®¹æ€§ã€‚(é‚£å¦‚æœæ˜¯åœ¨çº¿ä¸Šè¿è¡Œçš„appï¼Œå‡çº§ç³»ç»Ÿåå°±æ²¡åŠæ³•è¿è¡Œäº†) ä½¿ç”¨ Non Fragile ivars æ—¶ï¼Œç¨‹åºè¿›è¡Œæ£€æµ‹æ¥è°ƒæ•´ç±»ä¸­æ–°å¢çš„ ivar çš„åç§»é‡ã€‚ è¿™æ ·å°±å¯ä»¥é€šè¿‡ å¯¹è±¡åœ°å€ ï¼‹ åŸºç±»å¤§å° + ivaråç§»å­—èŠ‚ çš„æ–¹æ³•æ¥è®¡ç®—å‡º ivar ç›¸åº”çš„åœ°å€ï¼Œå¹¶è®¿é—®åˆ°ç›¸åº”çš„ ivarã€‚(å³ä½¿å‡çº§iOSç³»ç»Ÿï¼Œä¹‹å‰çš„appä¹Ÿèƒ½æ­£å¸¸è¿è¡Œ) æ‰©å±•å†æ‰©å±•ï¼šä¸ºä»€ä¹ˆOCç±»ä¸èƒ½åŠ¨æ€æ·»åŠ æˆå‘˜å˜é‡ï¼Ÿruntimeå‡½æ•°ä¸­ï¼Œç¡®å®æœ‰ä¸€ä¸ªclass_addIvar()å‡½æ•°ç”¨äºç»™ç±»æ·»åŠ æˆå‘˜å˜é‡ï¼Œä½†æ˜¯æ–‡æ¡£ä¸­ç‰¹åˆ«è¯´æ˜ï¼šThis function may only be called after objc_allocateClassPair and before objc_registerClassPair. Adding an instance variable to an existing class is not supported. è¿™ä¸ªå‡½æ•°åªèƒ½åœ¨â€œæ„å»ºä¸€ä¸ªç±»çš„è¿‡ç¨‹ä¸­â€è°ƒç”¨ã€‚ä¸€æ—¦å®Œæˆç±»å®šä¹‰ï¼Œå°±ä¸èƒ½å†æ·»åŠ æˆå‘˜å˜é‡äº†ã€‚ç»è¿‡ç¼–è¯‘çš„ç±»åœ¨ç¨‹åºå¯åŠ¨åå°±è¢«runtimeåŠ è½½ï¼Œæ²¡æœ‰æœºä¼šè°ƒç”¨addIvarã€‚ç¨‹åºåœ¨è¿è¡Œæ—¶åŠ¨æ€æ„å»ºçš„ç±»éœ€è¦åœ¨è°ƒç”¨objc_registerClassPairä¹‹åæ‰å¯ä»¥è¢«ä½¿ç”¨ï¼ŒåŒæ ·æ²¡æœ‰æœºä¼šå†æ·»åŠ æˆå‘˜å˜é‡ã€‚ç†è®ºä¸Šè¯´ï¼Œæˆ‘è¿˜æ˜¯è®¤ä¸ºå¯ä»¥æ·»åŠ ï¼Œåªæ˜¯ä¸ºä»€ä¹ˆä¸€å®šä¸å¯ä»¥ï¼Œå°±ä¸å¾—è€ŒçŸ¥äº†ã€‚ References objective-c non-fragile ivars å­¦ä¹ ç¬”è®° Non Fragile ivars","categories":[],"tags":[]},{"title":"OC Runtime å¤§æ‰‹ç¨¿ï¼šä¸€ã€æ•´ä½“æ•°æ®ç»“æ„","slug":"OCBigManuscript01_StructGlimpse","date":"2020-10-28T09:48:07.763Z","updated":"2020-11-01T01:42:33.739Z","comments":true,"path":"2020/10/28/OCBigManuscript01_StructGlimpse/","link":"","permalink":"http://yangzai360.top/2020/10/28/OCBigManuscript01_StructGlimpse/","excerpt":"å¤æ‚åº¦é«˜çš„é¡¹ç›®ç³»ç»Ÿï¼Œæˆ‘æƒ¯äºèŠ±æ—¶é—´æ¢³ç†å‡ºå¤§æ‰‹ç¨¿ï¼Œä½œä¸ºå‚è€ƒï¼Œæ ¹æ®è¿™ä¸ªæ€è·¯ï¼Œæˆ‘èŠ±æ—¶é—´å¯¹äºOCåº•å±‚çš„æœºåˆ¶è¿›è¡Œæ¢³ç†ï¼Œäº§å‡ºå¤§æ‰‹ç¨¿è‹¥å¹²ã€‚ å§‹ç¯‡ï¼Œä»å¯¹ç±»å¯¹è±¡ä½¿ç”¨çš„æ•°æ®ç»“æ„çš„é™æ€å…³è”åˆ†æå¼€å§‹ã€‚ä¹Ÿå°±æ˜¯ä»æºç ä¸­æ‰¾åˆ°ä»–ä»¬çš„å®šä¹‰å’Œå…³è”å…³ç³»ã€‚ä¸åšè¿è¡Œçš„åˆ†æç­‰ã€‚","text":"å¤æ‚åº¦é«˜çš„é¡¹ç›®ç³»ç»Ÿï¼Œæˆ‘æƒ¯äºèŠ±æ—¶é—´æ¢³ç†å‡ºå¤§æ‰‹ç¨¿ï¼Œä½œä¸ºå‚è€ƒï¼Œæ ¹æ®è¿™ä¸ªæ€è·¯ï¼Œæˆ‘èŠ±æ—¶é—´å¯¹äºOCåº•å±‚çš„æœºåˆ¶è¿›è¡Œæ¢³ç†ï¼Œäº§å‡ºå¤§æ‰‹ç¨¿è‹¥å¹²ã€‚ å§‹ç¯‡ï¼Œä»å¯¹ç±»å¯¹è±¡ä½¿ç”¨çš„æ•°æ®ç»“æ„çš„é™æ€å…³è”åˆ†æå¼€å§‹ã€‚ä¹Ÿå°±æ˜¯ä»æºç ä¸­æ‰¾åˆ°ä»–ä»¬çš„å®šä¹‰å’Œå…³è”å…³ç³»ã€‚ä¸åšè¿è¡Œçš„åˆ†æç­‰ã€‚ æ€è·¯æƒ³æ³•ï¼š æ•´ä½“æ•°æ®ç»“æ„ alloc init å®ä¾‹åŒ–æºç æµç¨‹ dealloc å¯¹è±¡æ¶ˆäº¡æºç æµç¨‹ åº”ç”¨ main ä¹‹å‰ï¼šmachoã€imageload æµç¨‹ æ¶ˆæ¯è°ƒç”¨æœºåˆ¶ï¼Œæ–¹æ³•æŸ¥æ‰¾æµç¨‹ åº”ç”¨å¸¸è§æ“ä½œåŸç†ï¼ˆä¾‹å¦‚superåŸç†ï¼‰ å…³è”å¯¹è±¡ &amp; methodSwi &amp; isaSwi Runtime æ‰€æœ‰ API æ±‡æ€»é€ŸæŸ¥ IDE ä¸Šé¢é»˜è®¤ä»£äº†ä¸€ä¸ªå‚æ•°ï¼Œç¦æ­¢äº†Runtimeçš„ä»£ç æç¤ºï¼Œæºç å’Œæ–‡æ¡£æ–¹é¢ä¹Ÿåˆ é™¤äº†ä¸€äº›è§£é‡Šï¼Œè¿™å«åš enable strict checking of objc_msgSend Calls æœ¬ç¯‡ï¼Œå®Œæˆæ¦‚è¦æ•´ä½“ç»“æ„ã€‚ä¸åŒ…æ‹¬ classdatabitst åˆ° ro rw rwe çš„æ¼”å˜ä»¥åŠåç»­è¿‡ç¨‹ã€‚ä¸åŒ…æ‹¬ objc_class ä¸­å¯¹äº cache çš„å¤„ç†ï¼ˆåœ¨æ–¹æ³•æŸ¥æ‰¾æµç¨‹é‡Œå†™ï¼‰ã€‚ æ•´ä½“ä»£ç åŸºäºç›®å‰å®˜æ–¹æœ€è¿‘å¼€æºçš„OCåº•å±‚æºç ç‰ˆæœ¬objc4_781ï¼Œä¸»è¦ç ”ç©¶ objc-runtime-new.h æ–‡ä»¶ï¼Œruntime è¿™éƒ¨åˆ†åŒ…ï¼š OC çš„å£°æ˜åçš„å®ç°éƒ¨åˆ†å¼€æºã€‚ åº•å±‚è°ƒç”¨çš„ C å’Œ C++ å¼€æºã€‚ æ±‡ç¼–è¯­è¨€.mmï¼ŒApple å¯¹äºä¸€éƒ¨åˆ†CC++æ— æ³•å®ç°çš„åŠŸèƒ½ä½¿ç”¨ï¼Œä¾‹å¦‚msgSend æ•´ä¸ªé€»è¾‘å…³ç³»å›¾å¦‚ä¸‹ 1. objc_object ã€Œä¸‡ç‰©ä¹‹æºã€è¿ç±»çš„ç»“æ„éƒ½æ˜¯åŸºäº objc_object çš„ï¼Œæ‰€ä»¥è¯´ OC é‡Œé¢ä¸€åˆ‡çš†å¯¹è±¡å‘¢ã€‚ objc_object 1234/// Represents an instance of a class.struct objc_object &#123; Class _Nonnull isa OBJC_ISA_AVAILABILITY;&#125;; 1.1 id å’Œ isaid çš„æœ¬è´¨å…¶å®å°±æ˜¯ä¸€ä¸ª objc_object * çš„ç»“æ„ä½“æŒ‡é’ˆ 12/// A pointer to an instance of a class.typedef struct objc_object *id; åœ¨ç»“æ„ä½“å†…éƒ¨åªæœ‰ä¸€ä¸ª Class ç»“æ„çš„ isa isa æ˜¯ä»€ä¹ˆï¼Ÿisa çš„æœ¬è´¨æ˜¯ isa_tï¼Œåœ¨å¦å¤–ä¸€ä¸ªæ–‡ä»¶ objc-private.h ä¸­æœ‰ isa_t çš„å®šä¹‰ï¼Œæ˜¯ä¸€ä¸ªè”åˆä½“ï¼Œä¹Ÿå«å…±ç”¨ä½“ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« è®²è§£å…±ç”¨ä½“ã€‚ 123456789101112union isa_t &#123; isa_t() &#123; &#125; isa_t(uintptr_t value) : bits(value) &#123; &#125; Class cls; uintptr_t bits;#if defined(ISA_BITFIELD) struct &#123; ISA_BITFIELD; // defined in isa.h &#125;;#endif&#125;; è¿™ä¸ªé‡Œé¢å­˜å‚¨ä¸¤ä¸ªï¼ŒClass cls å’Œ uintptr_t bitsã€‚å› ä¸ºæ˜¯è”åˆä½“ï¼Œæ‰€æœ‰å®é™…åªèƒ½æœ‰ä¸€ä¸ªå‡ºç°ï¼ŒISA_BITFIELDæ˜¯çœŸæ­£å­˜å‚¨å€¼çš„ä¸œè¥¿ï¼Œå®ƒå­˜å‚¨äºæ–‡ä»¶ isa.hï¼Œæ ¹æ®å¹³å°ä¸åŒè€Œä¸åŒï¼Œä¸‹é¢æ˜¯ arm64 ç‰ˆæœ¬çš„ï¼š ISA_BITFIELD 1234567891011121314151617# if __arm64__# define ISA_MASK 0x0000000ffffffff8ULL# define ISA_MAGIC_MASK 0x000003f000000001ULL# define ISA_MAGIC_VALUE 0x000001a000000001ULL# define ISA_BITFIELD\\ uintptr_t nonpointer : 1; /*0ï¼šä»£è¡¨æ™®é€šæŒ‡é’ˆï¼Œ1ï¼šè¡¨ç¤ºä¼˜åŒ–è¿‡çš„ï¼Œå¯ä»¥å­˜å‚¨æ›´å¤šä¿¡æ¯ã€‚*/\\ uintptr_t has_assoc : 1; /*æ˜¯å¦è®¾ç½®è¿‡å…³è”å¯¹è±¡ã€‚å¦‚æœæ²¡è®¾ç½®è¿‡ï¼Œé‡Šæ”¾ä¼šæ›´å¿«*/\\ uintptr_t has_cxx_dtor : 1; /*æ˜¯å¦æœ‰C++çš„ææ„å‡½æ•°*/\\ uintptr_t shiftcls : 33; /* MACH_VM_MAX_ADDRESS 0x1000000000 å†…å­˜åœ°å€å€¼*/ \\ uintptr_t magic : 6; /*ç”¨äºåœ¨è°ƒè¯•æ—¶åˆ†è¾¨å¯¹è±¡æ˜¯å¦æœªå®Œæˆåˆå§‹åŒ–*/\\ uintptr_t weakly_referenced : 1; /*æ˜¯å¦æœ‰è¢«å¼±å¼•ç”¨æŒ‡å‘è¿‡*/\\ uintptr_t deallocating : 1; /*æ˜¯å¦æ­£åœ¨é‡Šæ”¾*/\\ uintptr_t has_sidetable_rc : 1; /*å¼•ç”¨è®¡æ•°å™¨æ˜¯å¦è¿‡å¤§æ— æ³•å­˜å‚¨åœ¨ISAä¸­ã€‚å¦‚æœä¸º1ï¼Œé‚£ä¹ˆå¼•ç”¨è®¡æ•°ä¼šå­˜å‚¨åœ¨ä¸€ä¸ªå«åšSideTableçš„ç±»çš„å±æ€§ä¸­*/\\ uintptr_t extra_rc : 19; /*é‡Œé¢å­˜å‚¨çš„å€¼æ˜¯å¼•ç”¨è®¡æ•°å™¨å‡1*/\\# define RC_ONE (1ULL&lt;&lt;45)# define RC_HALF (1ULL&lt;&lt;18) è¿™ä¸ª ISA_MASK è¿™ç§çš„å°±æ˜¯ä¸€ä¸ªè’™ç‰ˆï¼Œisa å®Œæ•´çš„å€¼é€šè¿‡è·Ÿä»–è¿›è¡Œä¸æ“ä½œï¼Œå°±åªç•™ä¸‹äº†classçš„åœ°å€ï¼Œ(Class)(isa.bits &amp; ISA_MASK) è¯å¤–ä¸€æï¼Œobjc_object çš„ç»“æ„é™¤äº†ä¸Šé¢è¿™ä¸ªç»“æ„ï¼Œæ ¹æ®è¿™ä¸ªç»“æ„å­˜çš„å€¼ï¼Œæä¾›äº†ä¸€æ•´å¥—çš„APIæ–¹æ³•ï¼Œå­˜å‚¨äº objc_private.h æ–‡ä»¶ä¸­ã€‚ é‚£ä¹ˆ Class æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿçœ‹2.0 2. class ç»“æ„ä½“ï¼šobjc_classClass æ˜¯ objc_class * ç»“æ„ä½“æŒ‡é’ˆã€‚ objc_class 123456789struct objc_class : objc_object &#123; // Class ISA; Class superclass; cache_t cache; // formerly cache pointer and vtable class_data_bits_t bits; // class_rw_t * plus custom rr/alloc flags class_rw_t *data() const &#123; return bits.data(); &#125;&#125; è¿™é‡Œå…ˆåå­˜å‚¨çš„ä¸œè¥¿åˆ†å››ä¸ªï¼š ç»§æ‰¿æ¥çš„ isa ç»“æ„çš„æŒ‡é’ˆï¼Œå 8å­—èŠ‚ superClass çš„ Class æŒ‡é’ˆï¼Œå 8å­—èŠ‚ cacheç±»å‹ï¼Œæœ¬ç¯‡è·³è¿‡ã€‚ class_data_bits_tç±»å‹çš„bitsï¼Œä¸‹æ®µè½å±•å¼€ã€‚ 3. ç±»ä¸­æ•°æ® class_data_bits_tclass_data_bits_t é‡Œå­˜å‚¨ç€å½“å‰ç±»çš„å¾ˆå¤šä¿¡æ¯ï¼Œé€šè¿‡ class_data_bits_t è¿›è¡Œè’™ç‰ˆè¿ç®— (bits &amp; FAST_DATA_MASK) å¯ä»¥ç®—å‡º class_rw_tï¼Œç®€ç§°å°±æ˜¯ rwã€‚ä¸‹ä¸€æ®µè½é‡ç‚¹è®²è§£ class_rw_tã€‚ ro rwe å¦å¼€ç¯‡å¹…é‡ç‚¹è®²è§£ã€‚ class_data_bits_t 12345678910111213141516171819202122232425262728293031323334struct class_data_bits_t &#123; friend objc_class; // Values are the FAST_ flags above. uintptr_t bits;public: class_rw_t* data() const &#123; return (class_rw_t *)(bits &amp; FAST_DATA_MASK); &#125; void setData(class_rw_t *newData) &#123; ASSERT(!data() || (newData-&gt;flags &amp; (RW_REALIZING | RW_FUTURE))); //è¿™ä¸ªè¿‡ç¨‹ä¸éœ€è¦åŠ é”å¤„ç†ï¼Œå› ä¸ºä»…åœ¨å®ç°æˆ–æ„é€ æœŸé—´è¿›è¡Œ Set æ“ä½œ //ä½¿ç”¨ store-release fence æ“ä½œï¼Œç±»ä¼¼ä¸€ç§è½»é‡çº§çš„èµ„æºé”ï¼Œ //å¦‚ä¸‹é¢çš„`atomic_thread_fence `ï¼Œå› ä¸ºå¯èƒ½ä¼šåŒæ—¶å­˜åœ¨æ•°æ®çš„è¯»å†™ uintptr_t newBits = (bits &amp; ~FAST_DATA_MASK) | (uintptr_t)newData; atomic_thread_fence(memory_order_release); bits = newBits; &#125;//è·å–ç±»çš„roæ•°æ®ï¼Œå³ä½¿åœ¨æ„å»ºè¿‡ç¨‹ä¸­ã€‚//è¿™ä¸ªéœ€è¦ä¿®å¤ï¼Œè‡³å°‘åœ¨æ²¡æœ‰ç¼–è¯‘å™¨å±éšœçš„æƒ…å†µä¸‹ï¼Œå¹¶ä¸æ˜¯çœŸæ­£å®‰å…¨çš„ã€‚//åœ¨ å®ç°ç±» æ›´æ”¹æ•°æ®å­—æ®µçš„æ—¶å€™ï¼Œå¯èƒ½æ²¡æœ‰å†…å­˜å±éšœçš„ã€‚ const class_ro_t *safe_ro() &#123; class_rw_t *maybe_rw = data(); if (maybe_rw-&gt;flags &amp; RW_REALIZED) &#123; // maybe_rw is rw return maybe_rw-&gt;ro(); &#125; else &#123; // maybe_rw is actually ro return (class_ro_t *)maybe_rw; &#125; &#125;&#125; ä¸Šé¢ä»£ç æåˆ°äº†å†…å­˜å±éšœï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯å†…å­˜å±éšœï¼Œè¿™ä¸ªæ¦‚å¿µæ¶‰åŠåˆ°ä»£ç çš„ä¹±åºæ‰§è¡Œï¼Œå…·ä½“è§æ–‡ç« ã€Œå†…å­˜å±éšœï¼Œåˆæ˜¯ä¸€ä¸ªæ–‡ç« çš„å¼ºè¡Œå ä½ç¬¦ğŸ˜¬ã€ ro rw rwe æ˜¯ç›¸äº’ä¾å­˜çš„è¡¨è¿°ç±»ç»“æ„çš„ç»“æ„ï¼Œro æ˜¯åœ¨å†…å­˜ä¸­ç›´æ¥è¯»å–å‡ºæ¥çš„ï¼Œåªè¯»readonlyçš„ï¼Œå…¶ä¸­åŒ…æ‹¬äº†æˆ‘ä»¬ç†Ÿæ‚‰çš„ivarï¼Œæ‰€ä»¥è¯´ivaræ˜¯ä¸å¯ä»¥åŠ¨æ€æ·»åŠ çš„ï¼Œå°±æ˜¯è¿™ä¸ªåŸå› ã€‚ 3.1 ç±»æ•°æ®æ¼”å˜å‡ºï¼šclass_ro_tclass_ro_t 12345678910111213141516171819202122232425262728293031323334353637383940414243444546struct class_ro_t &#123; uint32_t flags; uint32_t instanceStart; uint32_t instanceSize;#ifdef __LP64__ uint32_t reserved;#endif const uint8_t * ivarLayout; const char * name; method_list_t * baseMethodList; protocol_list_t * baseProtocols; const ivar_list_t * ivars; const uint8_t * weakIvarLayout; property_list_t *baseProperties; // This field exists only when RO_HAS_SWIFT_INITIALIZER is set. _objc_swiftMetadataInitializer __ptrauth_objc_method_list_imp _swiftMetadataInitializer_NEVER_USE[0]; _objc_swiftMetadataInitializer swiftMetadataInitializer() const &#123; if (flags &amp; RO_HAS_SWIFT_INITIALIZER) &#123; return _swiftMetadataInitializer_NEVER_USE[0]; &#125; else &#123; return nil; &#125; &#125; method_list_t *baseMethods() const &#123; return baseMethodList; &#125; class_ro_t *duplicate() const &#123; if (flags &amp; RO_HAS_SWIFT_INITIALIZER) &#123; size_t size = sizeof(*this) + sizeof(_swiftMetadataInitializer_NEVER_USE[0]); class_ro_t *ro = (class_ro_t *)memdup(this, size); ro-&gt;_swiftMetadataInitializer_NEVER_USE[0] = this-&gt;_swiftMetadataInitializer_NEVER_USE[0]; return ro; &#125; else &#123; size_t size = sizeof(*this); class_ro_t *ro = (class_ro_t *)memdup(this, size); return ro; &#125; &#125;&#125;; å…¶ä¸­åŒ…å« const ivar_list_t * ivars ç”¨æ¥è¡¨ç¤º ivar_list_t å’Œ ivar_tã€‚ 3.1.1ivar_list_t å’Œ ivar_tivar_list_t é€šè¿‡ entsize_list_tt å­˜å‚¨äº† ivar_tã€‚ entsize_list_tt æ˜¯æä¾›éå†å™¨çš„é€šç”¨å®¹å™¨ï¼Œè¯¦ç»†è§æˆ‘åšå®¢çš„å¦ä¸€ç¯‡æ–‡ç« ï¼ŒAppleæºç ç”¨åˆ°çš„ä¸€äº›æ•°æ®ç»“æ„ã€‚ ivar_list_t 12345struct ivar_list_t : entsize_list_tt&lt;ivar_t, ivar_list_t, 0&gt; &#123; bool containsIvar(Ivar ivar) const &#123; return (ivar &gt;= (Ivar)&amp;*begin() &amp;&amp; ivar &lt; (Ivar)&amp;*end()); &#125;&#125;; ivar_t 123456789101112131415161718192021struct ivar_t &#123;#if __x86_64__ // *offset was originally 64-bit on some x86_64 platforms. // We read and write only 32 bits of it. // Some metadata provides all 64 bits. This is harmless for unsigned // little-endian values. // Some code uses all 64 bits. class_addIvar() over-allocates the // offset for their benefit.#endif int32_t *offset; const char *name; const char *type; // alignment is sometimes -1; use alignment() instead uint32_t alignment_raw; uint32_t size; uint32_t alignment() const &#123; if (alignment_raw == ~(uint32_t)0) return 1U &lt;&lt; WORD_SHIFT; return 1 &lt;&lt; alignment_raw; &#125;&#125;; 3.2 ç±»æ•°æ®æ¼”å˜å‡ºï¼šclass_rw_trw æ˜¯å¯è¯»å¯å†™çš„æ„æ€ï¼Œruntime åŠ¨æ€å¢åŠ æ–¹æ³•ç­‰å°±æ˜¯é€šè¿‡å¯¹ rw è¿›è¡Œä¿®æ”¹å†™çš„æ“ä½œå®Œæˆçš„ã€‚ è¿™é‡Œå…ˆçœ‹ä»–çš„ç»“æ„å®šä¹‰ï¼Œå¯¹å…¨å±€æœ‰äº†è§£ã€‚è¿™é‡Œåç»­ç« èŠ‚ã€Œã€‚ã€‚ã€‚ã€è¯¦ç»†å±•å¼€æ›´ç»†è‡´çš„ç ”ç©¶ã€‚ class_rw_t 1234567891011121314struct class_rw_t &#123; uint32_t flags; uint16_t witness;#if SUPPORT_INDEXED_ISA uint16_t index;#endif Class firstSubclass; Class nextSiblingClass;public: class_rw_ext_t *deepCopy(const class_ro_t *ro); const method_array_t methods(); const property_array_t properties(); const protocol_array_t protocols();&#125;; 3.3 ç±»æ•°æ®æ¼”å˜å‡ºï¼šclass_rw_ext_tå…·ä½“ä¸‰è€…å…³ç³»è¿™é‡Œå…ˆä¸èµ˜è¿°ã€‚ class_rw_ext_t 12345678struct class_rw_ext_t &#123; const class_ro_t *ro; method_array_t methods; property_array_t properties; protocol_array_t protocols; char *demangledName; uint32_t version;&#125;; 4. method_array_tã€ method_list_tã€ method_tæ¥ä¸‹æ¥ä¸‰éƒ¨åˆ†æ˜¯ï¼š ç±»çš„ rw rwe ä¸­çš„ method_array_t ç±»çš„ rw rwe ä¸­çš„ property_array_t ç±»çš„ rw rwe ä¸­çš„ protocol_array_t è¿™ä¸‰ä¸ªçš„ç»§æ‰¿æ•°æ®ç»“æ„éƒ½æ˜¯ï¼šlist_array_ttï¼Œè¯¦æƒ…å¯è§æˆ‘åšå®¢çš„å¦ä¸€ç¯‡æ–‡ç« ï¼ŒAppleæºç ç”¨åˆ°çš„ä¸€äº›æ•°æ®ç»“æ„ã€‚ é€šè¿‡ rw rwe ä¸­çš„ method_array_t è·å– methodsï¼Œå®ƒçš„ç±»å‹å®šä¹‰å¦‚ä¸‹ï¼š method_array_t 12345678910111213141516171819class method_array_t : public list_array_tt&lt;method_t, method_list_t&gt; &#123; typedef list_array_tt&lt;method_t, method_list_t&gt; Super; public: method_array_t() : Super() &#123; &#125; method_array_t(method_list_t *l) : Super(l) &#123; &#125; method_list_t * const *beginCategoryMethodLists() const &#123; return beginLists(); &#125; method_list_t * const *endCategoryMethodLists(Class cls) const; method_array_t duplicate() &#123; return Super::duplicate&lt;method_array_t&gt;(); &#125;&#125;; å…¶ä¸­è·å–åˆ°çš„ä¸€ä¸ªæˆ–å¤šä¸ª method_list_tï¼Œå…·ä½“åŸç†ç§»æ­¥åˆ°ä¸Šé¢æ–‡ç« ä¸­ã€‚ method_list_t 12345678910111213// entsize ä¸­çš„2ä¸ªå­—ç¬¦ä½ç”¨æ¥åš fixup æ ‡è®°ã€‚struct method_list_t : entsize_list_tt&lt;method_t, method_list_t, 0x3&gt; &#123; bool isUniqued() const; bool isFixedUp() const; void setFixedUp(); uint32_t indexOfMethod(const method_t *meth) const &#123; uint32_t i = (uint32_t)(((uintptr_t)meth - (uintptr_t)this) / entsize()); ASSERT(i &lt; count); return i; &#125;&#125;; é€šè¿‡éå†å™¨éå† method_t method_t å°±æ˜¯è¡¨ç¤ºä¸€ä¸ªæ–¹æ³•æˆ–è€…å‡½æ•°ï¼ˆåŒ…å«ï¼šå‡½æ•°åã€è¿”å›å€¼ã€å‚æ•°ã€å‡½æ•°ä½“ï¼‰ method_t 1234567891011121314struct method_t &#123; SEL name; // æ–¹æ³•åç§° const char *types; // ç¼–ç ï¼ˆè¿”å›å€¼ç±»å‹ã€å‚æ•°ç±»å‹ï¼‰ MethodListIMP imp; // æ–¹æ³•çš„åœ°å€/å®ç° struct SortBySELAddress : public std::binary_function&lt;const method_t&amp;, const method_t&amp;, bool&gt; &#123; bool operator() (const method_t&amp; lhs, const method_t&amp; rhs) &#123; return lhs.name &lt; rhs.name; &#125; &#125;;&#125;; SortBySELAddress()æ–¹æ³•æ˜¯æ–¹ä¾¿å‡½æ•°è¿›è¡Œæ’åºï¼Œå…¶å®åœ¨ methodListä¸­ å‡½æ•°æ˜¯æ ¹æ®SEL nameè¿™ä¸ªå¯¹è±¡çš„å†…å­˜åœ°å€è¿›è¡Œæ’åºçš„ï¼Œåç»­å¯»æ‰¾æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šç”¨äºŒåˆ†æŸ¥æ‰¾å¢åŠ æŸ¥æ‰¾æ•ˆç‡ã€‚ 4.1 method_t æ–¹æ³•çš„æ•°æ®ç»“æ„SELæ˜¯ä¸€ä¸ªæŒ‡å‘objc_selector ç»“æ„ä½“çš„æŒ‡é’ˆï¼štypedef struct objc_selector *SEL; è·å–ä¸€ä¸ªSELçš„æ–¹æ³• 1234567SEL sel1 &#x3D; @selector(selector);SEL sel2 &#x3D; sel_registerName(&quot;selector&quot;);SEL sel3 &#x3D; NSSelectorFromString(@&quot;selector&quot;);&#x2F;&#x2F; SEL è½¬æ¢æˆå­—ç¬¦ä¸²char *string1 &#x3D; sel_getName(sel1);NSString *string2 &#x3D; NSStringFromSelector(sel1); IMP æ˜¯æŒ‡å‘æ–¹æ³•å®ç°æçš„å‡½æ•°æŒ‡é’ˆï¼Œè°ƒç”¨ä¸€ä¸ªæ–¹æ³•ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªæ–¹æ³•å¯»å€çš„è¿‡ç¨‹ï¼Œé€šè¿‡SELå¯»æ‰¾IMPã€‚method_tï¼Œå°±æ˜¯åœ¨ä¸¤è€…ä¹‹é—´åšæ˜ å°„å…³ç³» 12345#if !OBJC_OLD_DISPATCH_PROTOTYPEStypedef void (*IMP)(void &#x2F;* id, SEL, ... *&#x2F; ); #elsetypedef id _Nullable (*IMP)(id _Nonnull, SEL _Nonnull, ...); #endif 4.2 Type EncodingsType Encodings å°±æ˜¯ä¸€ä¸ªç¼–ç ï¼Œruntime ä¸­å¯¹äº method_t çš„è¿”å›å€¼å’Œå‚æ•°ï¼Œä½¿ç”¨äº†Type Encodings å­—ç¬¦ä¸²æ¥è¿›è¡Œæè¿°ï¼š@encode()æŒ‡ä»¤å¯ä»¥å°†ç±»å‹è½¬æ¢ä¸º Type Encodings å­—ç¬¦ä¸²ç¼–ç ï¼š 123char *buf1 = @encode(int **);char *buf2 = @encode(struct key);char *buf3 = @encode(Rectangle); OC æ–¹æ³•éƒ½æœ‰ä¸¤ä¸ªéšå¼å‚æ•°ï¼Œæ–¹æ³•è°ƒç”¨è€… (id)self å’Œæ–¹æ³•å (SEL) _cmd ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰èƒ½åœ¨æ–¹æ³•ä¸­ä½¿ç”¨ self å’Œ _cmd ï¼› å¦‚ -(void)testï¼Œå®ƒçš„ç¼–ç ä¸º â€œv16@0:8â€ï¼Œå¯ä»¥ç®€å†™ä¸º â€œv@:â€vï¼šä»£è¡¨è¿”å›å€¼ç±»å‹ä¸º void16ï¼šä»£è¡¨æ‰€æœ‰å‚æ•°æ‰€å çš„æ€»å­—èŠ‚æ•°@ï¼šä»£è¡¨å‚æ•° 1 ç±»å‹ä¸º id0ï¼šä»£è¡¨å‚æ•° 1 ä»ç¬¬å‡ ä¸ªå­—èŠ‚å¼€å§‹å­˜å‚¨:ï¼šä»£è¡¨å‚æ•° 2 ç±»å‹ä¸º SEL8ï¼šä»£è¡¨å‚æ•° 2 ä»ç¬¬å‡ ä¸ªå­—èŠ‚å¼€å§‹å­˜å‚¨ å…·ä½“è¿™é‡Œåœ¨å®˜ç½‘ä¸Šæœ‰è¯¦ç»†è§£é‡Šï¼ŒSee Type Encodings in Objective-C Runtime Programming Guideã€‚ 5. property_array_tã€ property_list_tã€ property_tproperty_array_t 12345678910111213class property_array_t : public list_array_tt&lt;property_t, property_list_t&gt; &#123; typedef list_array_tt&lt;property_t, property_list_t&gt; Super; public: property_array_t() : Super() &#123; &#125; property_array_t(property_list_t *l) : Super(l) &#123; &#125; property_array_t duplicate() &#123; return Super::duplicate&lt;property_array_t&gt;(); &#125;&#125;; property_list_t 12struct property_list_t : entsize_list_tt&lt;property_t, property_list_t, 0&gt; &#123;&#125;; property_t 1234struct property_t &#123; const char *name; const char *attributes;&#125;; 6. protocol_array_tã€ protocol_list_tã€ protocol_tprotocol_array_t 1234567891011121314class protocol_array_t : public list_array_tt&lt;protocol_ref_t, protocol_list_t&gt; &#123; typedef list_array_tt&lt;protocol_ref_t, protocol_list_t&gt; Super; public: protocol_array_t() : Super() &#123; &#125; protocol_array_t(protocol_list_t *l) : Super(l) &#123; &#125; protocol_array_t duplicate() &#123; return Super::duplicate&lt;protocol_array_t&gt;(); &#125;&#125;; protocol_list_t 1234567891011121314151617181920212223242526272829struct protocol_list_t &#123; // count is pointer-sized by accident. uintptr_t count; protocol_ref_t list[0]; // variable-size size_t byteSize() const &#123; return sizeof(*this) + count*sizeof(list[0]); &#125; protocol_list_t *duplicate() const &#123; return (protocol_list_t *)memdup(this, this-&gt;byteSize()); &#125; typedef protocol_ref_t* iterator; typedef const protocol_ref_t* const_iterator; const_iterator begin() const &#123; return list; &#125; iterator begin() &#123; return list; &#125; const_iterator end() const &#123; return list + count; &#125; iterator end() &#123; return list + count; &#125;&#125;; protocol_t 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849struct protocol_t : objc_object &#123; const char *mangledName; struct protocol_list_t *protocols; method_list_t *instanceMethods; method_list_t *classMethods; method_list_t *optionalInstanceMethods; method_list_t *optionalClassMethods; property_list_t *instanceProperties; uint32_t size; // sizeof(protocol_t) uint32_t flags; // Fields below this point are not always present on disk. const char **_extendedMethodTypes; const char *_demangledName; property_list_t *_classProperties; const char *demangledName(); const char *nameForLogging() &#123; return demangledName(); &#125; bool isFixedUp() const; void setFixedUp(); bool isCanonical() const; void clearIsCanonical();# define HAS_FIELD(f) (size &gt;= offsetof(protocol_t, f) + sizeof(f)) bool hasExtendedMethodTypesField() const &#123; return HAS_FIELD(_extendedMethodTypes); &#125; bool hasDemangledNameField() const &#123; return HAS_FIELD(_demangledName); &#125; bool hasClassPropertiesField() const &#123; return HAS_FIELD(_classProperties); &#125;# undef HAS_FIELD const char **extendedMethodTypes() const &#123; return hasExtendedMethodTypesField() ? _extendedMethodTypes : nil; &#125; property_list_t *classProperties() const &#123; return hasClassPropertiesField() ? _classProperties : nil; &#125;&#125;; 6.isa èµ°ä½å›¾è¿™ä¸ªå›¾è§£é‡Šç½‘ä¸Šå¤ªå¤šäº†ï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œæ”¾è¿™é‡Œï¼Œè·³è¿‡ä¸è®²äº†ã€‚ æ‹“å±•ç ”ç©¶å†…å­˜å±éšœ memory barrierä¸Šé¢æºç ä¸­ class_ro_t *safe_ro() çš„æ³¨é‡Šé‡Œæåˆ°äº†ä¸€ä¸ªçš„ compiler barrierï¼Œç¼–è¯‘å™¨å±éšœï¼Œè¿™ä¸ªæ˜¯ä¸ºäº†è§£å†³ä»£ç æ‰§è¡Œé—®é¢˜çš„ã€‚ æŒ‡ä»¤é‡æ’æ˜¯æŒ‡ï¼šå¯¼è‡´çš„ä»£ç ä¹±åºæ‰§è¡Œã€‚ä¸¾ä¾‹æ¥è¯´ï¼šå¦‚æœç¬¬ä¸€ä¸ªè¯­å¥æ¶‰åŠå†…å­˜è¯»å–ï¼Œç¬¬äºŒä¸ªè¯­å¥åªæ˜¯ç®€å•çš„æŒ‡ä»¤è®¡ç®—ï¼Œé‚£ä¹ˆCPUä¸ºäº†æé«˜æ•ˆç‡ï¼Œå®Œå…¨å¯èƒ½åœ¨ç¬¬ä¸€ä¸ªè¯­å¥çš„å†…å­˜è¯»å–å®Œæˆä¹‹å‰ï¼Œå…ˆæ‰§è¡Œå®Œäº†ç¬¬äºŒä¸ªè¯­å¥ã€‚ ä¸Šä¸‹ä¸¤æ¡æŒ‡ä»¤æ²¡æœ‰ç›¸å…³æ€§ï¼Œå°±å¯èƒ½å‘ç”Ÿã€‚å¦‚æœæ¶‰åŠä¸€ä¸ªå€¼ï¼Œå°±æœ‰å¯èƒ½å‘ç°ã€‚å¦å¤–ä¸€ä¸ªæ¦‚å¿µå«åš as if serialï¼Œé‡æ’åºçš„åŸåˆ™æ˜¯çœ‹ä¸Šå»åƒæ˜¯é¡ºåºæ‰§è¡Œçš„ï¼Œä¸å½±å“å•çº¿ç¨‹çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚ ä½†æ˜¯å¤šçº¿ç¨‹æ˜¯ä¸ä¿è¯ä¸€è‡´æ€§çš„ã€‚æ‰€ä»¥é‡æ’åºæ˜¯CPUçš„å…¬å…±ç‰¹æ€§ã€‚ ç„¶åå°±å‡ºç°äº†ï¼Œå†…å­˜å±éšœ memory barrierå±éšœä¸Šä¸‹çš„æŒ‡ä»¤ä¸ä¼šå‘ç”Ÿé‡æ’åºï¼Œåœ¨æ±‡ç¼–å±‚é¢ï¼Œé€šè¿‡ lock æ±‡ç¼–æŒ‡ä»¤å®Œæˆï¼Œlockæ˜¯é”æ€»çº¿ï¼ŒCPUè®¿é—®å†…å­˜çš„æ€»çº¿ï¼Œç­‰æŒ‡ä»¤è®¿é—®å®Œäº†ï¼Œå…¶ä»–CPUæ‰èƒ½å»è®¿é—®ã€‚ lock æœ¬èº«çš„å‰é¢çš„æ‰€æœ‰æŒ‡ä»¤å…¨éƒ¨ä¸èƒ½è¶Šè¿‡ lock é‡æ’åºã€‚ æ‹“å±•é˜…è¯»ï¼šLinuxå†…æ ¸åŒæ­¥æœºåˆ¶ä¹‹ï¼ˆä¸‰ï¼‰ï¼šmemory barrier References objc4_781 å®˜æ–¹æºç  ç®€å›¾è®°å½•-android fenceæœºåˆ¶ Fenceå’ŒéåŸå­æ“ä½œçš„ordering Cè¯­è¨€å…±ç”¨ä½“ï¼ˆCè¯­è¨€unionç”¨æ³•ï¼‰è¯¦è§£ã€‚ è¡¥å……gitä¸Šæ‰¾åˆ°çš„ä¸€ä¸ª o_t c_t ro rw rwe è¿é€šå›¾ï¼Œåå­—æˆ‘è‡ªå·±çèµ·çš„ï¼Œæˆ‘åé¢ç”»å›¾ä¼šå‚è€ƒè¿™ä¸ª","categories":[],"tags":[]}],"categories":[],"tags":[]}